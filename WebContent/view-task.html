<!DOCTYPE html>
<!--[if IE 9 ]><html class="ie9"><![endif]-->
<head>

<title>Vertex Dashboard</title>

<!-- CSS -->
<link href="/vertex/resources/css/bootstrap.min.css" rel="stylesheet">
<link href="/vertex/resources/css/animate.min.css" rel="stylesheet">
<link href="/vertex/resources/css/font-awesome.min.css" rel="stylesheet">
<link href="/vertex/resources/css/form.css" rel="stylesheet">
<link href="/vertex/resources/css/calendar.css" rel="stylesheet">
<link href="/vertex/resources/css/style.css" rel="stylesheet">
<link href="/vertex/resources/css/icons.css" rel="stylesheet">
<link href="/vertex/resources/css/generics.css" rel="stylesheet">
</head>
<body id="skin-blur-blue">

	<header id="header" class="media">
		<a href="" id="menu-toggle"></a> <a class="logo pull-left"
			href="/vertex/index.html">Vertex Dashboard</a>

		<div class="media-body">
			<div class="media" id="top-menu">
				<div id="time" class="pull-right">
					<span id="hours"></span> : <span id="min"></span> : <span id="sec"></span>
				</div>
			</div>
		</div>
	</header>

	<div class="clearfix"></div>

	<section id="main" class="p-relative" role="main">

		<!-- Sidebar -->
		<aside id="sidebar">

			<!-- Sidbar Widgets -->
			<div class="side-widgets overflow">
				<!-- Profile Menu -->
				<div class="text-center s-widget m-b-25 dropdown" id="profile-menu">
					<a href="" data-toggle="dropdown"> <img
						class="profile-pic animated"
						src="/vertex/resources/img/profile-pics/male-user-icon.jpg" alt="">
					</a>
					<ul class="dropdown-menu profile-menu">
						<li><a href="/vertex/tasks.html">My Tasks</a> <i class="icon left">&#61903;</i><i
							class="icon right">&#61815;</i></li>
						<li><a id="signout" href="/vertex/logout">Sign Out</a> <i class="icon left">&#61903;</i><i
							class="icon right">&#61815;</i></li>
					</ul>
					<h4 id="userFullName" class="m-0"></h4>
				</div>

				<!-- Calendar -->
				<div class="s-widget m-b-25">
					<div id="sidebar-calendar"></div>
				</div>

				<!-- Feeds -->
				<div class="s-widget m-b-25">
					<h2 class="tile-title">Recent Activities</h2>

					<div class="s-widget-body">
						<div id="eventssection" class="media p-l-5"></div>
						<div class="media p-l-5">
							<div id="noeventsmessage" hidden=true class="text-center">
								<a class="t-overflow" href="">You are not subscribed for any
									events yet.</a>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Side Menu -->
			<ul class="list-unstyled side-menu">
				<li class="active"><a class="sa-side-home" href="index.html">
						<span class="menu-item">Dashboard</span>
				</a></li>
			</ul>

		</aside>

		<!-- Content -->
		<section id="content" class="container">


			<section id="main" class="p-relative" role="main">

				<h4 id="tasktitle" class="page-title"></h4>

				<div class="block-area">
					<div class="row">
						<div class="col-md-9">
							<div class="tile-light p-5 m-b-15">
								<div id="taskdescr" class="p-5 m-t-15"></div>
							</div>

							<div class="m-b-15 text-center profile-summary">
								<div id="task-status-change" class="btn-group m-b-5">
									<button id="task-status" type="button" class="btn btn-sm dropdown-toggle"
										data-toggle="dropdown"></button>
								</div>
								<div id="prio-change-opt" class="btn-group m-b-5">
									<button id="task-prio" type="button" class="btn btn-sm dropdown-toggle"
										data-toggle="dropdown">Critical</button>
								</div>
								<div class="btn-group m-b-5">
									<button id="task-comments-count" type="button" class="btn btn-sm dropdown-toggle"
										data-toggle="dropdown"></button>
								</div>
								<div class="btn-group m-b-5">
									<button id="task-subsc" type="button" class="btn btn-sm dropdown-toggle"
										data-toggle="dropdown"></button>
								</div>
							</div>
						</div>

						<div class="col-md-3">

							<!-- About Me -->
							<div class="tile">
								<h2 class="tile-title">Task Details</h2>

								<div class="listview icon-list">
									<div class="media">
										<i class="icon pull-left">&#61784</i>
										<div id="taskdet-id" class="media-body"></div>
									</div>
									<div class="media">
										<i class="icon pull-left">&#61750</i>
										<div id="taskdet-proj" class="media-body"></div>
									</div>

									<div class="media">
										<i class="icon pull-left">&#61868</i>
										<div id="taskdet-cre-date" class="media-body">Created at </div>
									</div>

									<div class="media">
										<i class="icon pull-left">&#61766</i>
										<div id="taskdet-mod-date" class="media-body">Last modified at </div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div id="comments-section" class="block-area" id="well">
					<h3 class="block-title">Comments</h3>
				</div>
				<div class="block-area" id="well">
					<form class="row form-columned" role="form">
						<h3 class="block-title">Leave a Comment</h3>
						<textarea id="taskdef" class="markdown-editor"
							placeholder="Comment goes here..."></textarea>
						<button id="submitcomment" type="submit" class="btn btn-sm">Submit</button>
						<br />
					</form>
					<br /> <br />
				</div>
				<div class="clearfix"></div>
			</section>
		</section>
	</section>

	<!-- Javascript Libraries -->
	<!-- jQuery -->
	<script src="/vertex/resources/js/jquery.min.js"></script>
	<!-- jQuery Library -->
	<script src="/vertex/resources/js/jquery-ui.min.js"></script>
	<!-- jQuery UI -->
	<script src="/vertex/resources/js/jquery.easing.1.3.js"></script>
	<!-- jQuery Easing - Requirred for Lightbox + Pie Charts-->

	<!-- Bootstrap -->
	<script src="/vertex/resources/js/bootstrap.min.js"></script>

	<!-- Charts -->
	<script src="/vertex/resources/js/charts/jquery.flot.js"></script>
	<!-- Flot Main -->
	<script src="/vertex/resources/js/charts/jquery.flot.time.js"></script>
	<!-- Flot sub -->
	<script src="/vertex/resources/js/charts/jquery.flot.animator.min.js"></script>
	<!-- Flot sub -->
	<script src="/vertex/resources/js/charts/jquery.flot.resize.min.js"></script>
	<!-- Flot sub - for repaint when resizing the screen -->

	<script src="/vertex/resources/js/sparkline.min.js"></script>
	<!-- Sparkline - Tiny charts -->
	<script src="/vertex/resources/js/easypiechart.js"></script>
	<!-- EasyPieChart - Animated Pie Charts -->
	<script src="/vertex/resources/js/charts.js"></script>
	<script src="/vertex/resources/js/select.min.js"></script>
	<!-- All the above chart related functions -->

	<!-- Map -->
	<script src="/vertex/resources/js/maps/jvectormap.min.js"></script>
	<!-- jVectorMap main library -->
	<script src="/vertex/resources/js/maps/usa.js"></script>
	<!-- USA Map for jVectorMap -->

	<!--  Form Related -->
	<script src="/vertex/resources/js/icheck.js"></script>
	<!-- Custom Checkbox + Radio -->

	<!-- UX -->
	<script src="/vertex/resources/js/scroll.min.js"></script>
	<!-- Custom Scrollbar -->

	<!-- Other -->
	<script src="/vertex/resources/js/calendar.min.js"></script>
	<!-- Calendar -->
	<script src="/vertex/resources/js/feeds.min.js"></script>
	<script src="/vertex/resources/js/markdown.min.js"></script>

	<script src="/vertex/resources/js/functions.js"></script>
	<script src="/vertex/resources/js/template.js"></script>

	<script>
		$(document).ready(function() {
			user = getUser();
			getEvents();
			
			var taskId = getParameterByName("taskId", document.URL);
			if (!taskId) {
				window.location.replace('404.html')
			}

			loadTask(taskId);

		});

		function loadTask(taskId) {
			$.ajax({
				url : "/vertex/api/task/" + taskId,
				type : "GET",
				success : function(jqXHR) {
					showTask(jqXHR);
				},
				error : function(jqXHR) {
					alert('This task could not be loaded.')
				}
			});
		}

		function showTask(task) {
			$("#tasktitle").append(task.taskId + ": " + task.title);
			$("#taskdet-id").append(task.taskId);
			$("#taskdet-proj").append("Project "+ task.projectName);
			$("#task-subsc").append(task.subscribersCount + " Watchers");
			$("#taskdet-cre-date").append(new Date(task.creationTime).toLocaleString());
			$("#taskdet-mod-date").append(new Date(task.modificationTime).toLocaleString());
			
			var taskDef = task.definition;
			if (!taskDef) {
				$("#taskdescr").append("<center><i>No description was provided for this task</i></center>");
			} else {
				$("#taskdescr").append(task.definition);
			}
			
			showPriority(task);
			showStatus(task);
			showComments(task);
		}
		
		function showComments(task) {
			var comments = task.comments;
			var commentCount = (comments) ? comments.length : 0;
			$("#task-comments-count").append(commentCount + ' Comments');
			if (commentCount > 0) {
				var commentsHtml = '';
				for (i = 0; i < commentCount; i++) {
					var comment = comments[i];
					commentsHtml += '<div class="media-body">' + comment.commentator +' at at ' + new Date(comment.creationTime).toLocaleString() + '</div>';
					commentsHtml += '<div class="well tile">' + comment.content + '</div>';
				}
				$("#comments-section").append(commentsHtml);
			} else {
				$("#comments-section").append('<div class="well tile"><i>No comments for this task yet.</i></div>');
			}
			
			$("#submitcomment").on('click', function(event) {
				event.preventDefault();
				
				var commentData = {
					content : $("#taskdef").val(),
				};
				
				$.ajax({
					url : "/vertex/api/task/" + task.taskId + '/comment',
					type : "POST",
					data : JSON.stringify(eval(commentData)),
					contentType: "application/json",
					success : function() {
						location.reload();
					},
					error : function(jqXHR) {
						alert("Unfortunately, your comment could not be submitted.")
					}
				});
			});
		}
		
		function showPriority(task) {
			$("#task-prio").text(showEnum(task.priority));
			
			var priorities = [ 'MINOR', 'MAJOR', 'CRITICAL', 'BLOCKER'];
			var prioIndex = priorities.indexOf(task.priority);
			
			priorities.splice(prioIndex, 1);
			if (priorities.length > 0) {
				var prioHtml = '<ul class="dropdown-menu animated flipInX">';
				for (i = 0; i < priorities.length; i++) {
					prioHtml += '<li><a class="prioChange">' + priorities[i] + '</a></li>';
				}
				prioHtml += '</ul>';
				$("#prio-change-opt").append(prioHtml);
			}
			
			
			$(".prioChange").click(function(event) {
				event.preventDefault();
				var chosenPrio = $(this).text();
				var requestData = { "priority": chosenPrio };
				$.ajax({
					url : "/vertex/api/task/" + task.taskId + "/priority",
					type : "PUT",
					contentType: "application/json",
					data: JSON.stringify(requestData),
					success : function(jqXHR) {
						alert("Tast priority was successfully changed. The page will be reloaded.");
						location.reload();
					},
					error : function(jqXHR) {
						alert('Unfortunately, the priority of this task could not be changed.')
					}
				});
			});
		}
		
		function showStatus(task) {
			$("#task-status").text(showEnum(task.status));
			
			var statuses = [ 'NEW', 'ACCEPTED', 'IN_PROGRESS', 'RESOLVED'];
			var statusIndex = statuses.indexOf(task.status);
			
			var statusActions = [ 'Accept', 'Start Progress', 'Resolve'];
			var activeActions = statusActions.slice(statusIndex);
			
			if (activeActions.length > 0) {
				var taskStatusHtml = '<ul class="dropdown-menu animated flipInX">';
				for (i = 0; i < activeActions.length; i++) {
					taskStatusHtml += '<li><a class="statusAction">' + activeActions[i] + '</a></li>';
				}
				taskStatusHtml += '</ul>';
				$("#task-status-change").append(taskStatusHtml);
			}
			
			
			$(".statusAction").click(function(event) {
				 event.preventDefault();
				 var actionData = { "Accept": "ACCEPTED", 'Start Progress': "IN_PROGRESS", 'Resolve': "RESOLVED" };
				 var chosenAction = $(this).text();
				 var requestData = { "status": actionData[chosenAction] };
				 $.ajax({
						url : "/vertex/api/task/" + task.taskId + "/status",
						type : "PUT",
						contentType: "application/json",
						data: JSON.stringify(requestData),
						success : function(jqXHR) {
							alert("Tast status was successfully changed. The page will be reloaded.");
							location.reload();
						},
						error : function(jqXHR) {
							alert('Unfortunately, the status of this task could not be changed.')
						}
					});
			});
		}

		function getParameterByName(name, url) {
			if (!url)
				url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex
					.exec(url);
			if (!results)
				return null;
			if (!results[2])
				return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		
		function showEnum(x) {
			return x.split('_').map(function(x){ return x.toUpperCase() }).join(" ")
		}
		
		function capitalize(s){
		    return s.toLowerCase().replace( /\b./g, function(a){ return a.toUpperCase(); } );
		}
	</script>
</body>
</html>
